version: '3.4'

x-logging:
  &default-logging
  options:
    max-size: 50m

services:
  web:
    image: registry.ely.by/elyby/accounts-nginx:latest
    restart: always
    depends_on:
      - app
      - emails-renderer
    env_file: .env
    volumes:
      - ./frontend:/var/www/html/frontend
    networks:
      - default
      - nginx-proxy
    logging: *default-logging

  app:
    image: registry.ely.by/elyby/accounts:latest
    restart: always
    depends_on:
      - db
      - redis
    env_file: .env
    volumes:
      - certs-storage:/var/www/html/data/certs
    networks:
      default:
        aliases:
          - php
    logging: *default-logging

  worker:
    image: registry.ely.by/elyby/accounts:latest
    restart: always
    command: ['php', 'yii', 'queue/listen', '-v']
    depends_on:
      - db
      - redis
    env_file: .env
    logging: *default-logging

  cron:
    image: registry.ely.by/elyby/accounts:latest
    restart: always
    command: ['crond', '-s', '/etc/cron.d', '-f', '-L', '/var/log/cron.log']
    stop_signal: SIGKILL
    depends_on:
      - db
      - redis
    env_file: .env
    logging: *default-logging

  emails-renderer:
    image: elyby/emails-renderer:dev
    logging: *default-logging

  db:
    image: registry.ely.by/elyby/accounts-mariadb:latest
    restart: always
    env_file: .env
    volumes:
      - ./data/mysql:/bitnami/mariadb

  redis:
    image: redis:3.0-alpine
    restart: always
    volumes:
      - ./data/redis:/data

volumes:
  certs-storage:
    driver: local
    driver_opts:
      type: none
      device: $PWD/data/certs
      o: bind

networks:
  nginx-proxy:
    external:
      name: nginx-proxy
